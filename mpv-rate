#!/bin/bash

# This is just a wrapper around mpv that outputs the total mean
# bitrate at the end (and that exits if the bitrate is below the
# optional cutoff.
#
# It requires socat (to talk to a socket) and jq (to parse JSON).  And
# mpv, to play a video.

url="$1"
cutoff="$2"

if [ "$url" = "" ]; then
    echo "Usage: $0 <url> [cutoff]"
    exit
fi

socket="/tmp/mpv-$$"

if [ -e "$socket" ]; then
    rm "$socket"
fi

DISPLAY=:1 /usr/src/mpv/build/mpv -vo=x11 --no-audio --quiet --input-ipc-server="$socket" --fullscreen "$url" >/dev/null 2>/dev/null &

mpv="$!"

times=0
while ps -p $mpv >/dev/null; do
    data=$(echo '{ "command": ["get_property", "video-bitrate"] }' | socat - "$socket")
    state=$(jq -r .error <<< "$data")
    if [ "$state" = "success" ]; then
	rate=$(jq -r .data <<< "$data")
	total=$(($total + $rate))
	times=$(($times + 1))
	echo $(($total / $times))
	if [ "$cutoff" != "" ]; then
	    if [ $(($total / $times)) -lt "$cutoff" ]; then
		echo $(($total / $times))
		kill -9 $mpv
		exit
	    fi
	fi
    fi
    sleep 1
done

rm -f "$socket"

echo $(($total / $times))
